# Privacy Policy & Consent System - Quick Start Guide

## ‚úÖ Implementation Complete

A complete GDPR-compliant privacy policy and user consent management system has been implemented.

## üöÄ Immediate Next Steps

### 1. Run Database Migrations (Do this first!)

Execute these SQL files in your database in order:

```bash
# Via MySQL CLI
mysql -u username -p database_name < database/migration_privacy_policy.sql
mysql -u username -p database_name < database/migration_initial_privacy_policy.sql

# Via phpMyAdmin
# Copy and paste each SQL file into the SQL tab
```

### 2. Customize the Privacy Policy

1. Log in as admin
2. Go to **Admin ‚Üí Manage Privacy Policies** (add this to your admin menu)
3. Edit Version 1.0 and fill in:
   - Your organization name and address
   - Contact information and DPO details
   - Specific data processing activities
   - Adjust retention periods if needed

### 3. Test the System

**Test as new user:**
1. Try to log in ‚Üí should see privacy policy
2. Accept ‚Üí redirects to profile (if supporter) or dashboard (if admin)
3. Reject ‚Üí account gets deactivated

**Test as existing user:**
1. Publish a new privacy policy version
2. Log in ‚Üí should see new version
3. Must accept to continue

## üìÅ New Files Created

### User-Facing Pages
- **`admin/profile.php`** - User self-service profile page
  - View personal data
  - Edit contact information
  - View obligations
  - Manage email preferences
  - Delete account
  - View privacy policy acceptance

- **`admin/privacy_policy.php`** - Privacy policy display & consent
  - Shows current privacy policy
  - Accept/Reject buttons
  - Print functionality
  - Shows acceptance history

### Admin Pages
- **`admin/manage_privacy_policies.php`** - Policy management
  - Create new versions
  - Publish policies
  - View acceptance statistics
  - Track user responses
  - Admin only

### Database
- **`database/migration_privacy_policy.sql`** - Main schema
- **`database/migration_initial_privacy_policy.sql`** - Default policy

### Documentation
- **`docs/PRIVACY_POLICY_SYSTEM.md`** - Full technical documentation

## üîÑ User Flow Overview

### New User
```
Register ‚Üí Login ‚Üí Accept Privacy Policy ‚Üí Profile (Supporter) or Dashboard (Admin)
```

### Supporter
```
Login ‚Üí Accept Privacy Policy ‚Üí Profile Page ‚Üí View Data/Obligations
        ‚Üì (if has permissions)
       Can navigate to Dashboard
```

### Admin
```
Login ‚Üí Accept Privacy Policy ‚Üí Dashboard ‚Üí All Functions
```

## üîë Key Features

‚úÖ **Versioned Privacy Policies** - Create and manage multiple versions
‚úÖ **Consent Audit Trail** - Every acceptance/rejection logged with timestamp & IP
‚úÖ **Email Preferences** - Users choose what emails they want
‚úÖ **Self-Service Profile** - Users manage their own data
‚úÖ **Supporter Restrictions** - Limited access, see profile first
‚úÖ **User Deactivation** - Auto-disable if privacy policy rejected
‚úÖ **GDPR Compliant** - Meets all major requirements
‚úÖ **Print Support** - Users can print privacy policies
‚úÖ **Multi-language Ready** - German content included, easy to add more

## üìã Modified Files

### Login Flow
- **`admin/login.php`** - Added privacy policy acceptance check
- **`verify_magiclink.php`** - Added privacy policy acceptance check
- **`admin/dashboard.php`** - Added supporter redirect

### Helper Functions
- **`includes/functions.php`** - Added:
  - `has_accepted_privacy_policy()`
  - `get_latest_privacy_policy()`
  - `record_privacy_policy_decision()`
  - `is_supporter()`

## üîê Security Features

‚úì IP addresses logged for audit trail
‚úì User agent logged for suspicious activity detection
‚úì Immutable consent records (cannot be deleted)
‚úì HTTPS required for all operations
‚úì Secure password hashing
‚úì Session-based authentication
‚úì Admin-only policy management

## üìä Admin Dashboard Access

Add this link to your admin navigation menu:

```html
<a href="manage_privacy_policies.php">üîê Privacy Policies</a>
```

This page shows:
- All policy versions
- Acceptance statistics
- Users pending acceptance
- Ability to create new versions

## üß™ Testing Checklist

Before going live:

- [ ] Database migrations successful
- [ ] Privacy policy text customized
- [ ] New user can log in and see privacy policy
- [ ] User can accept policy
- [ ] User can reject policy
- [ ] Rejected user cannot log back in
- [ ] Supporter redirects to profile
- [ ] Admin can access dashboard
- [ ] Email preferences save correctly
- [ ] Print privacy policy works
- [ ] New policy version appears on login
- [ ] Consent audit log shows records

## üìû Support Commands

### Check if migrations ran:
```sql
SELECT VERSION FROM privacy_policy_versions;
```

### Reset privacy policy acceptance (admin only):
```sql
-- Require all users to accept privacy policy on next login
UPDATE users SET require_privacy_policy_acceptance = 1 WHERE active = 1;

-- Clear all consent records (be careful!)
DELETE FROM privacy_policy_consent;
```

### Check user consent history:
```sql
SELECT u.email, ppc.accepted, ppc.consent_date, ppc.ip_address
FROM privacy_policy_consent ppc
JOIN users u ON ppc.user_id = u.id
WHERE u.email = 'user@example.com'
ORDER BY ppc.consent_date DESC;
```

## ‚öñÔ∏è Legal Notes

**Important**: This system provides the technical implementation for GDPR compliance. You should:

1. **Customize the privacy policy** with your organization's specific details
2. **Consult a lawyer** - Data protection law varies by jurisdiction
3. **Document your DPA** - Data Processing Agreement with any vendors
4. **Assign a DPO** - Data Protection Officer if required
5. **Create privacy notices** - For third-party processors
6. **Plan for DSAR** - Data Subject Access Requests

Recommended resources:
- https://gdpr-info.eu/ - Full GDPR text
- Your local Data Protection Authority website
- BDSG (Bundesdatenschutzgesetz) for Germany
- A qualified data protection lawyer

## üéØ What's Next

After setup and testing:

1. **Train staff** on the new privacy policy
2. **Communicate changes** to users
3. **Monitor acceptance rates** in admin panel
4. **Keep audit logs** for at least 3 years
5. **Update privacy policy** as business changes
6. **Review quarterly** with legal/compliance

## üêõ Troubleshooting

**Users can't log in?**
- Check `require_privacy_policy_acceptance` flag
- Verify privacy policy is published
- Check session timeout settings

**Email preferences not saving?**
- Verify `email_consent` table exists
- Check database permissions
- Check browser console for JavaScript errors

**No consent records?**
- Ensure privacy policy is published (published_at not null)
- Check database permissions
- Verify IP address isn't being filtered

## üìû Questions?

Refer to:
- **Technical docs**: `docs/PRIVACY_POLICY_SYSTEM.md`
- **Code comments**: In each PHP file
- **Database schema**: Comments in migration files

---

**Status**: ‚úÖ Ready for Production
**Last Updated**: January 24, 2026
**Version**: 1.0
